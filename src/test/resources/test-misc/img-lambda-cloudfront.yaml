
AWSTemplateFormatVersion: "2010-09-09"
Description: "Image Resizer stack with Cloudfront-s3 static website- API Gateway - Lambda function - s3"

Parameters:
  DefaultRootObject:
    Description: 'The default path for the index document.'
    Type: String    
    Default: 'index.html'

  ErrorPagePath:
    Description: 'The path of the error page for the website (e.g. /error.html). Must be a root-relative path.'
    Type: String
    Default: '/404.html'  
    
  PublicDomainName:
    Description: 'Public Domain Name'
    Type: String

  LambdaCodeS3BucketName:
    Description: 'Bucket where code is located'
    Type: String

  LambdaCodeS3BucketKey:
    Description: 'Bucket key for the lambda function'
    Type: String

  
  ImageCloudfrontName:
    Description: 'distribution alias'
    Type: String

  AcmCertificateArn:
    Type: String
    Description: >
      The ARN of the SSL certificate to use for the CloudFront distribution.

  ImageSourceBucket:  
    Description: 'Image source bucket'
    Type: String
    

  apiGatewayStageName:
    Type: "String"
    AllowedPattern: "^[a-z0-9]+$"
    Default: "call"

  lambdaFunctionName:
    Type: "String"
    AllowedPattern: "^[a-zA-Z0-9]+[a-zA-Z0-9-]+[a-zA-Z0-9]+$"
    

  ImageDestBucketName:
    Type: String

Mappings:
  Region2S3WebsiteSuffix:
    us-east-1:
      Suffix: .s3-website-us-east-1.amazonaws.com
    us-west-1:
      Suffix: .s3-website-us-west-1.amazonaws.com
    us-west-2:
      Suffix: .s3-website-us-west-2.amazonaws.com
    eu-west-1:
      Suffix: .s3-website-eu-west-1.amazonaws.com
    ap-northeast-1:
      Suffix: .s3-website-ap-northeast-1.amazonaws.com
    ap-northeast-2:
      Suffix: .s3-website-ap-northeast-2.amazonaws.com
    ap-southeast-1:
      Suffix: .s3-website-ap-southeast-1.amazonaws.com
    ap-southeast-2:
      Suffix: .s3-website-ap-southeast-2.amazonaws.com
    ap-south-1:
      Suffix: .s3-website-ap-south-1.amazonaws.com
    us-east-2:
      Suffix: .s3-website-us-east-2.amazonaws.com
    sa-east-1:
      Suffix: .s3-website-sa-east-1.amazonaws.com
    cn-north-1:
      Suffix: .s3-website.cn-north-1.amazonaws.com.cn
    eu-central-1:
      Suffix: .s3-website.eu-central-1.amazonaws.com

Resources:

  ImageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join ['.', [!Ref 'ImageDestBucketName',  !Ref 'PublicDomainName']]
      # Set the CORS policy
      CorsConfiguration:
        CorsRules:
          -
            AllowedOrigins:
              - '*'
            AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - PUT
              - POST
              - HEAD
            MaxAge: 3000     

      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
        RoutingRules:
          - RedirectRule:
              HttpRedirectCode: 307
              HostName: !Sub "${apiGateway}.execute-api.${AWS::Region}.amazonaws.com"
              Protocol: https
              ReplaceKeyPrefixWith: call?key=
            RoutingRuleCondition:
              HttpErrorCodeReturnedEquals: 404

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Id: ImageBucketPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PublicReadForGetBucketObjects
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref ImageBucket
                - /*
      Bucket: !Ref ImageBucket

  apiGateway:
    Type: "AWS::ApiGateway::RestApi"
    Properties:
      Name: "my-api"
      Description: "My API"

  apiGatewayRootMethod:
    Type: "AWS::ApiGateway::Method"
    Properties:
      AuthorizationType: "NONE"
      HttpMethod: "POST"
      Integration:
        IntegrationHttpMethod: "POST"
        Type: "AWS_PROXY"
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "lambdaFunction.Arn"
      ResourceId: !GetAtt "apiGateway.RootResourceId"
      RestApiId: !Ref "apiGateway"

  apiGatewayRootMethodGet:
    Type: "AWS::ApiGateway::Method"
    Properties:
      AuthorizationType: "NONE"
      HttpMethod: "GET"
      Integration:
        IntegrationHttpMethod: "POST"
        Type: "AWS_PROXY"
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "lambdaFunction.Arn"
      ResourceId: !GetAtt "apiGateway.RootResourceId"
      RestApiId: !Ref "apiGateway"

  apiGatewayDeployment:
    Type: "AWS::ApiGateway::Deployment"
    DependsOn:
      - "apiGatewayRootMethod"
      - "apiGatewayRootMethodGet"
    Properties:
      RestApiId: !Ref "apiGateway"
      StageName: !Ref "apiGatewayStageName"



  lambdaFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Code: 
        S3Bucket: !Ref 'LambdaCodeS3BucketName'
        S3Key: !Ref 'LambdaCodeS3BucketKey'
      
      Description: "Image resizer function"
      Environment:
        Variables:
          sourcebucket: !Ref 'ImageSourceBucket'
          destbucket:    !Ref ImageBucket
          cloudfronturl: !Join ['', ['https://', !GetAtt ImageApiCloudFrontDistribution.DomainName]] 
      FunctionName: !Ref "lambdaFunctionName"
      Handler: "app/index.handler"
      Role: !GetAtt "lambdaIAMRole.Arn"
      Runtime: nodejs12.x
      MemorySize: 512
      Timeout: 10

  lambdaApiGatewayInvokePOST:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !GetAtt "lambdaFunction.Arn"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${apiGateway}/*/POST/"


  lambdaApiGatewayInvokeGET:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !GetAtt "lambdaFunction.Arn"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${apiGateway}/*/GET/"

  lambdaIAMRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - "sts:AssumeRole"
            Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Effect: "Allow"
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${lambdaFunctionName}:*"
          PolicyName: "lambda"
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:*                 
                Effect: "Allow"
                Resource:
                  - !Sub arn:aws:s3:::${ImageBucket}/*
          PolicyName: "lambdaS3DestPolicy"
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:*                 
                Effect: "Allow"
                Resource:
                  - !Sub arn:aws:s3:::${ImageSourceBucket}/*
          PolicyName: "lambdaS3SourcePolicy"



  lambdaLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${lambdaFunctionName}"
      RetentionInDays: 1


  ImageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ImageBucket
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Principal: "*"
            Resource: !Sub arn:aws:s3:::${ImageBucket}/*


  # Configure the bucket as a CloudFront Origin
  ReadPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref ImageBucket
      PolicyDocument:
        Statement:
        - Action: 's3:GetObject'
          Effect: Allow
          Resource: !Sub 'arn:aws:s3:::${ImageBucket}/*'
          Principal:
            CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId

  CloudFrontOriginAccessIdentity:
    Type: 'AWS::CloudFront::CloudFrontOriginAccessIdentity'
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Ref ImageBucket


  ImageApiCloudFrontDistribution:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig:
        CustomErrorResponses:
        - ErrorCode: 403 # not found
          ResponseCode: 404
          ResponsePagePath: !Ref ErrorPagePath
        Aliases:
          - !Join ['.', [!Ref 'ImageCloudfrontName',  !Ref 'PublicDomainName']]      
        DefaultCacheBehavior:
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          Compress: true
          DefaultTTL: 0 # in seconds
          ForwardedValues:
            Cookies:
              Forward: none
            QueryString: false
          MaxTTL: 1209610 # in seconds
          MinTTL: 0 # in seconds
          TargetOriginId: s3origin
          ViewerProtocolPolicy: 'allow-all'
        DefaultRootObject: !Ref DefaultRootObject
        Enabled: true
        HttpVersion: http2
        Origins:
        - DomainName:  !Join ['', [!Ref 'ImageBucket', !FindInMap [Region2S3WebsiteSuffix,
                !Ref 'AWS::Region', Suffix]]]
          Id: s3origin
          CustomOriginConfig:
            HTTPPort: '80'
            HTTPSPort: '443'
            OriginProtocolPolicy: http-only
        PriceClass: 'PriceClass_All'
        ViewerCertificate:
          AcmCertificateArn: !Ref AcmCertificateArn
          MinimumProtocolVersion: TLSv1
          SslSupportMethod: sni-only



# CDNDNSName: notes        
#         the HostedZoneId is for cloudfront from this page
#         https://docs.aws.amazon.com/Route53/latest/APIReference/API_AliasTarget.html

  ImageApiCDNDNSName:
    Type: AWS::Route53::RecordSetGroup
    Properties:
        HostedZoneName: !Join ['', [!Ref 'PublicDomainName' , .]]
        RecordSets:
        - Name: !Join ['.', [!Ref 'ImageCloudfrontName',  !Ref 'PublicDomainName']]      
          Type: A
          AliasTarget:
            HostedZoneId:   Z2FDTNDATAQYW2
            DNSName: !GetAtt ImageApiCloudFrontDistribution.DomainName

Outputs:
  apiGatewayInvokeURL:
    Value: !Sub "https://${apiGateway}.execute-api.${AWS::Region}.amazonaws.com/${apiGatewayStageName}"
  lambdaArn:
    Value: !GetAtt "lambdaFunction.Arn"
  BucketWebsiteUrl:
    Value: !GetAtt ImageBucket.WebsiteURL
  Bucket:
    Value: !Ref ImageBucket    

  Staticweb:
     Value:  !Join ['', [!Ref 'ImageBucket', !FindInMap [Region2S3WebsiteSuffix,
                !Ref 'AWS::Region', Suffix]]]
  WebsiteURL:
    Value: !GetAtt 
      - ImageBucket
      - WebsiteURL
    Description: URL for website hosted on S3
  S3BucketSecureURL:
    Value: !Join 
      - ''
      - - 'https://'
        - !GetAtt 
          - ImageBucket
          - DomainName
    Description: Name of S3 bucket to hold website content

  ImageCloudfrontDistributionId:
    Description: 'CloudFront Distribution ID'
    Value: !Ref ImageApiCloudFrontDistribution

  ImageCloudfrontDomain:
    Description: 'Cloudfront Domain'
    Value: !GetAtt ImageApiCloudFrontDistribution.DomainName

  ImageCloudfrontDistributionAlias:
    Description: The alias for image cloudfront distribution or cname 
    Value: !Join ['.', [!Ref 'ImageCloudfrontName',  !Ref 'PublicDomainName']]      